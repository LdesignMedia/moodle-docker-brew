#!/bin/bash -i
# Author: Luuk Verhoeven
# Date: 01.05.2023, 06:20
# Description:
# Simple starter for Moodle docker containers.
# Uses https://github.com/moodlehq/moodle-docker
# Tested on MacOS with https://orbstack.dev/download
#
#
#                               `.:;+o***ooi;.`
#                                `,;o*%%&##########&*:`
#                              '+&%%%***%%%%&$$$$$$$##&i`
#                            `+$$%********%&$$$$$$$$$$$#&,
#                           ,&&%*********&$$$$$$$$$$$$$$$$:
#                          ,#$%********&$$$$$$$$$$$$$$$$$$o:
#                         .$$$$&*****%%$$$########$$$$$$$$*i:
#                         %$$##$&%**%$%.'..,::;i+*$$$$$$$$*i+.
#                        '$#&o;,&$&&$$$+;ooi;:;i*%&$$$$$$$*iii
#                        .$+::,;$$$$$$$$#$*%;`',,+#$$$$$$$oiii`
#                        .oo&%&$$$$$$$$$$%*%,'.$&:.$$$$$$$+iii`
#                        .#*+:`+$$$$$$$$$@%.,,+@@@i&$$$$$&iiii'
#                        ,*.*,`+#$$$$$$$$#@#&$@@@##$$$$$$%iii;
#                        ,,*%;+##$$$$$$$$$$$$$$$$$$$$$$$$oiioo,
#                        .$&@@##$$$$##$$$$$$$$$$$$$$$$$$$i+%*o%;
#                        .$$&&&$%$$&**$$$$$$$$$$$$$$$$$$%i+i;;;+.
#                        .$$$$$$oiii;o$$$$$$$$$$$$$$$$$$oii;i;ii,
#                        .$$$$$$$%%%$#$$$$$$$$$$$$$$$$$&iii;ii;+,
#                        '$$$$$$$$$$$$$$$$$$$$$$$$$$$$$*iiiii;ii`
#                        '$$$$$$$$$$$$$$&&&&$$$$$$$$$$&iii;;ii:'
#                         &$$$$$&&&&&$&&&$$$$$$$$$$$$#*i++ii,`
#                         o#$$$$&&$$&&$$$$$$$$$$$$$$#%+;'..`
#                         .#$$$$$$%o+%$$$$$$$$$$$$$$%+i`
#                          ;#$$$$$$$$$$$$$$$$$$$$$$*ii`
#                           :$#$$$$$$$$$$$$$$$$$&*+;i;
#                            'o#$$$$$$$$$$$$$&%oi;;;i;....'
#                              ,&#$$$$$$$$%o+i;;;iii+;...,::
#                               `;%###$%oi;;;iiiiiiii;,:;;ii`
#                                `.;ii;;;;;;i;i;;;;;;iiiiiii`
#                              `.....',+ii+*%*iiiiiiiiiiiii;
#                             ;**%%,..;$*i%$$$%;iiiiiiiiiii;
#                             ;#$$$+..i##%&$$&$*;iiiiiiiiii;
#                             `&$&$*.';%**$$$$$$o;iiiiiiiiii'
#                              +$&$&,,ioi%$$$$$$$o;iiiiiiiii: `
#                              o$&$$+oooo$$$$$$$$$+;iiiiii;;:.''
#                             '%$&$$*+o+*$$$$$$$$$$o;;;:;;:,.'.,,'
#                           `,i*&$$$%+o+&$$$$$$&&%%*oo++;:,''.:;;;;,.
#                         `'::*%o%$$&++o$$$$&%******%%o+:::io*ooo**%%o;.`
#                       ';*i:;%*%**&$o+&$&%****%%%%%oi::;+*%%%%%%%%**%%%*+:
#                     ,+%%%;:i%*%%****o%*****%%%%%*i::;+*%%******%%%%***%%%+`
#                   :*%%***;:;*%%*%%*******%%*%%*i;,;+*%%*%%%%%%%%%%%%%%***%i
#                 `o%%****%;::*%*%%o*%%%%*o+o**i;:;i*%%*%%%%%%%%%%%%%%%%%%**%.
#                 +%**%%%%%i::o%%oio%**%%%%*i:;,;;*%%**%%%%%%%%%%%%%%%%%%%*%*;'
#

# Examples:
# moodle-docker help
# moodle-docker start 45
# moodle-docker start 42
# moodle-docker start 41
# moodle-docker start 311
# moodle-docker start 39
# moodle-docker update 41
# moodle-docker stop 41
# moodle-docker destroy 41
# moodle-docker behat 41 addtional

# TODO Flip arguments and support MWP eg moodle-docker 44mwp start | moodle-docker 44lms start

# VARS.
ORIGINAL_DIR=$(pwd)
SCRIPT_DIR_MOODLE_DOCKER="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# TODO compare against brew list --versions moodle-docker start upgrade if its higher than current
PLUGIN_VERSION="1.0.24"

MOODLE_LIST=$(cat $SCRIPT_DIR_MOODLE_DOCKER/moodle_VERSIONS.txt)
VERSIONS=$(echo "$MOODLE_LIST" | awk -F'|' '{ print $1 }')
ARG2_SELECTED_VERSION=""
VERSION_FOUND=0
ARG1_ACTION="$1"
ARG2_SELECTED_VERSION="$2"
# ----------------------------------------------------------------

source "$SCRIPT_DIR_MOODLE_DOCKER/scripts/helper.sh"

# Below is the alias (moodle-docker) to https://github.com/LdesignMedia/homebrew-moodle-docker/blob/main/install_moodle_docker.sh this is used for
# installing and workarround home directory issues.
# Header section
log ""
log "========================================================================"
log "${GREEN}Moodle Docker Brew v$PLUGIN_VERSION${RESET}"
log "by Ldesign Media - https://ldesignmedia.nl"
log "========================================================================"
log ""
log "üìÅ Working directory: $SCRIPT_DIR_MOODLE_DOCKER"
log "üìñ Documentation: https://github.com/LdesignMedia/moodle-docker-brew"
log ""

# Brew version check
BREW_VERSION=$(brew list --versions moodle-docker 2>/dev/null || echo "not installed via brew")
if [ "$BREW_VERSION" != "not installed via brew" ]; then
  log "üç∫ Homebrew version: $BREW_VERSION"
  log ""
fi

if [ "$ARG1_ACTION" == "help" ]; then
  log "Usage: $0 command moodleversion [arg3 arg4 ...]"
  log "command: start | update | stop | destroy | info | behat | phpunit | upgrade | grunt"
  log "Example of moodleversion: 45, 44, 43, 42, 41, 40, 311, 310, 39"
  log "More arguments are optional for phpunit or behat"

  abort "-"
fi

if [ "$ARG1_ACTION" == "upgrade" ]; then
  cd "$SCRIPT_DIR_MOODLE_DOCKER" || abort "~/moodle-docker-brew is missing"
  log "${GREEN}Moodle upgrade brew package"

  # Check if the brew package itself has changed.
  brew update
  brew upgrade moodle-docker

  # Cleanup old  .gitmodules
  rm -f .gitmodules > /dev/null

  # Update the main repo.
  git pull
  git fetch origin
  git reset --hard origin/main
  git clean -fd

  # Update the submodule (git@github.com:moodlehq/moodle-docker.git).
  log "Updating moodlehq-docker"

  # If folder not exists clone the repository
  if [ ! -d "$SCRIPT_DIR_MOODLE_DOCKER/moodlehq-docker" ]; then
    log "${GREEN}Install moodlehq-docker"
    git clone git@github.com:moodlehq/moodle-docker.git moodlehq-docker
  fi

  # Update the official docker suite from Moodle.
  cd "$SCRIPT_DIR_MOODLE_DOCKER/moodlehq-docker" || abort "~/moodle-docker-brew/moodlehq-docker is missing"
  git pull
  git fetch origin
  git reset --hard origin/main
  git clean -fd

  # Back to the original directory.
  cd "$ORIGINAL_DIR" || exit

  exit 0
fi

# Validate we can run the script.
setup

# Check if at least two argument is provided
if [ "$#" -lt 2 ]; then
  abort "Usage: $0 command moodleversion [arg3 arg4 ...]"
fi

# Check if the provided version is in the list
for version in $VERSIONS; do
  if [ "$version" == "$ARG2_SELECTED_VERSION" ]; then
    VERSION_FOUND=1
    break
  fi
done

if [ ! $VERSION_FOUND -eq 1 ]; then
  abort "The provided version $ARG2_SELECTED_VERSION is not in the Moodle version list."
fi

# Get the corresponding download URL
download_url=$(echo "$MOODLE_LIST" | grep "^$ARG2_SELECTED_VERSION|" | awk -F'|' '{ print $2 }')

if [ -z "$download_url" ]; then
  abort "Invalid selection. Please try again."
fi

# Remove the first argument
shift
shift
ALL_REMAINING_ARGS="$@"

# Validate the first argument
case "$ARG1_ACTION" in
start | update | stop | destroy | info | behat | phpunit | grunt) ;;
*)
  abort "Error: Invalid first argument. Allowed values are: start, update, stop, destroy, behat, phpunit, upgrade, grunt."
  ;;
esac

# Configuration Section
log "------------------------------------------------------------------------"
log "${GREEN}üìã Configuration${RESET}"
log "------------------------------------------------------------------------"
log "  Moodle version: ${GREEN}$ARG2_SELECTED_VERSION${RESET}"
if [ -n "$ALL_REMAINING_ARGS" ]; then
  log "  Extra arguments: $ALL_REMAINING_ARGS"
fi

# EXPORTS ----------------------------------------------------------------
export COMPOSE_PROJECT_NAME="moodle${ARG2_SELECTED_VERSION}"
export MOODLE_DOCKER_DB=mariadb
export MOODLE_DOCKER_DB_PORT="330${ARG2_SELECTED_VERSION}"
export MOODLE_DOCKER_SELENIUM_VNC_PORT="590${ARG2_SELECTED_VERSION}"
export MOODLE_DOCKER_WEB_PORT="80${ARG2_SELECTED_VERSION}"
export MOODLE_DOCKER_WWWROOT="${SCRIPT_DIR_MOODLE_DOCKER}/moodle/${ARG2_SELECTED_VERSION}"

# Set PHP for older versions
if [ "$ARG2_SELECTED_VERSION" == "39" ]; then
  export MOODLE_DOCKER_PHP_VERSION=7.4
  log "  PHP version: ${GREEN}7.4${RESET}"
elif [ "$ARG2_SELECTED_VERSION" -ge "44" ]; then
  export MOODLE_DOCKER_PHP_VERSION=8.1
  log "  PHP version: ${GREEN}8.1${RESET}"
else
  log "  PHP version: ${GREEN}8.0${RESET}"
  export MOODLE_DOCKER_PHP_VERSION=8.0
fi

log "  Database: ${GREEN}MariaDB${RESET}"
log "  Directory: $MOODLE_DOCKER_WWWROOT"
log ""
log "------------------------------------------------------------------------"
log "${GREEN}üîå Service Ports${RESET}"
log "------------------------------------------------------------------------"
log "  üåê Web server: ${CYAN}http://localhost:$MOODLE_DOCKER_WEB_PORT/${RESET}"
log "  üóÑÔ∏è  Database: ${CYAN}localhost:$MOODLE_DOCKER_DB_PORT${RESET}"
log "  üñ•Ô∏è  VNC (Selenium): ${CYAN}localhost:$MOODLE_DOCKER_SELENIUM_VNC_PORT${RESET} (password: secret)"
log ""
log "------------------------------------------------------------------------"
log "${GREEN}üîë Access Credentials${RESET}"
log "------------------------------------------------------------------------"
log "  Admin login: ${CYAN}admin / test${RESET}"
log ""
log "------------------------------------------------------------------------"
log "${GREEN}üõ†Ô∏è  Development Tools${RESET}"
log "------------------------------------------------------------------------"
log "  üìß Mail catcher: ${CYAN}http://localhost:$MOODLE_DOCKER_WEB_PORT/_/mail/${RESET}"
log "  üß™ Behat faildumps: ${CYAN}http://localhost:$MOODLE_DOCKER_WEB_PORT/_/faildumps/${RESET}"
log "  üìù Behat definitions: ${CYAN}http://localhost:$MOODLE_DOCKER_WEB_PORT/admin/tool/behat/index.php${RESET}"
log ""
log "------------------------------------------------------------------------"
log "${GREEN}üìö Documentation${RESET}"
log "------------------------------------------------------------------------"
log "  Behat guide: https://moodledev.io/general/development/tools/behat"
log "  Writing tests: https://moodledev.io/general/development/tools/behat/writing"
log "  PHPUnit tests: https://docs.moodle.org/dev/Writing_PHPUnit_tests"
log "------------------------------------------------------------------------"
log ""

# ----------------------------------------------------------------

# START COMMAND
# ----------------------------------------------------------------
if [ "$ARG1_ACTION" == "start" ]; then
  log ""
  log "========================================================================"
  log "${GREEN}üöÄ Starting Moodle $ARG2_SELECTED_VERSION${RESET}"
  log "========================================================================"
  log ""

  # Download the zip file to the moodle directory and name it using the selected_version
  zip_file="$SCRIPT_DIR_MOODLE_DOCKER/moodle/${ARG2_SELECTED_VERSION}.zip"

  if [ ! -f "$zip_file" ]; then
    log "üì• Downloading Moodle $ARG2_SELECTED_VERSION..."
    log "   Source: $download_url"
    log ""

    if command -v wget >/dev/null 2>&1; then
      wget -O "$zip_file" "$download_url"
    elif command -v curl >/dev/null 2>&1; then
      curl -o "$zip_file" -L "$download_url"
    else
      abort "‚ùå Error: wget or curl is required to download the Moodle version."
    fi

    log "${GREEN}‚úì${RESET} Downloaded successfully to: $zip_file"
  else
    log "${GREEN}‚úì${RESET} Using cached download: $zip_file"
  fi

  # Unzipping Moodle.
  if [ ! -f "$zip_file" ]; then
    abort "‚ùå Failed to download $download_url"
  fi

  if [ ! -d "$SCRIPT_DIR_MOODLE_DOCKER/moodle/${ARG2_SELECTED_VERSION}" ]; then
    log "üì¶ Extracting Moodle files..."
    rm -rf "$SCRIPT_DIR_MOODLE_DOCKER/moodle/moodle"
    unzip -q "$zip_file" -d "$SCRIPT_DIR_MOODLE_DOCKER/moodle/"
    mv "$SCRIPT_DIR_MOODLE_DOCKER/moodle/moodle" "$SCRIPT_DIR_MOODLE_DOCKER/moodle/${ARG2_SELECTED_VERSION}"

    log "${GREEN}‚úì${RESET} Extracted to: ${SCRIPT_DIR_MOODLE_DOCKER}/moodle/${ARG2_SELECTED_VERSION}"
  else
    log "${GREEN}‚úì${RESET} Moodle directory exists: ${SCRIPT_DIR_MOODLE_DOCKER}/moodle/${ARG2_SELECTED_VERSION}"
  fi

  log ""
  log "üê≥ Docker Project: ${CYAN}$COMPOSE_PROJECT_NAME${RESET}"
  log ""

  cp "$SCRIPT_DIR_MOODLE_DOCKER/moodlehq-docker/config.docker-template.php" "$MOODLE_DOCKER_WWWROOT/config.php"
  cd "$SCRIPT_DIR_MOODLE_DOCKER/moodlehq-docker" || abort "moodlehq-docker is missing"

  # Make sure Moodle is installed.
  if [ ! -f "$MOODLE_DOCKER_WWWROOT/version.php" ]; then
    abort "Failed to install Moodle in ($MOODLE_DOCKER_WWWROOT)"
  fi

  if [ ! -f "$MOODLE_DOCKER_WWWROOT/installed" ]; then

    log "üîß Setting up Docker containers..."
    bin/moodle-docker-compose up -d

    log "‚è≥ Waiting for database to be ready..."
    bin/moodle-docker-wait-for-db

    # Flag so we don't run this more than once.
    touch "$MOODLE_DOCKER_WWWROOT/installed"

    log "üóÑÔ∏è  Installing Moodle database..."
    bin/moodle-docker-compose exec webserver php admin/cli/install_database.php --agree-license --fullname="$COMPOSE_PROJECT_NAME" \
      --shortname="$COMPOSE_PROJECT_NAME" --summary="Docker moodle site $COMPOSE_PROJECT_NAME" --adminpass="test" --adminemail="admin@example.com"

    log "${GREEN}‚úì${RESET} Moodle database installed successfully"
    log ""

    # Add moodle developer tools.
    log "üß™ Initializing test frameworks..."

    # Initialize behat environment.
    log "  ‚Ä¢ Setting up Behat (acceptance testing)..."
    bin/moodle-docker-compose exec webserver php admin/tool/behat/cli/init.php
    log "${GREEN}  ‚úì${RESET} Behat initialized"

    # Initialize phpunit environment.
    log "  ‚Ä¢ Setting up PHPUnit (unit testing)..."
    bin/moodle-docker-compose exec webserver php admin/tool/phpunit/cli/init.php
    log "${GREEN}  ‚úì${RESET} PHPUnit initialized"
  else
    # Restart containers
    log "‚ôªÔ∏è  Restarting existing containers..."
    bin/moodle-docker-compose start
    log "${GREEN}‚úì${RESET} Containers restarted"
  fi

  log ""
  log "========================================================================"
  log "${GREEN}‚úÖ Moodle $ARG2_SELECTED_VERSION is ready!${RESET}"
  log "========================================================================"
  log ""
  log "üåê Access your site at: ${CYAN}http://localhost:$MOODLE_DOCKER_WEB_PORT/${RESET}"
  log "üë§ Login: ${CYAN}admin / test${RESET}"
  log ""

# DESTROY COMMAND
# ----------------------------------------------------------------
elif [ "$ARG1_ACTION" == "destroy" ]; then
  log ""
  log "========================================================================"
  log "${RED}üóëÔ∏è  Destroy Moodle $ARG2_SELECTED_VERSION${RESET}"
  log "========================================================================"
  log ""
  log "${YELLOW}‚ö†Ô∏è  This will permanently delete:${RESET}"
  log "  ‚Ä¢ All Docker containers for Moodle $ARG2_SELECTED_VERSION"
  log "  ‚Ä¢ Database and all data"
  log "  ‚Ä¢ Moodle installation directory"
  log "  ‚Ä¢ Downloaded zip file"
  log ""

  if confirm "${RED}Are you sure you want to proceed?${RESET}"; then

    # Shut down and destroy containers
    cd "$SCRIPT_DIR_MOODLE_DOCKER/moodlehq-docker" || abort "moodlehq-docker is missing"

    log "üîÑ Shutting down containers..."
    bin/moodle-docker-compose down
    log "${GREEN}‚úì${RESET} Containers removed"

    log "üóëÔ∏è  Deleting Moodle files..."
    rm -rf "$MOODLE_DOCKER_WWWROOT"
    rm "$SCRIPT_DIR_MOODLE_DOCKER/../moodle/$ARG2_SELECTED_VERSION.zip" >/dev/null 2>&1
    log "${GREEN}‚úì${RESET} Files deleted"

    log ""
    log "${GREEN}‚úÖ Moodle $ARG2_SELECTED_VERSION has been completely removed.${RESET}"
    log ""
  else
    log "${YELLOW}‚ùå Operation cancelled.${RESET}"
  fi

# STOP COMMAND
# ----------------------------------------------------------------
elif [ "$ARG1_ACTION" == "stop" ]; then
  log ""
  log "========================================================================"
  log "${YELLOW}‚èπÔ∏è  Stopping Moodle $ARG2_SELECTED_VERSION${RESET}"
  log "========================================================================"
  log ""

  cd "$SCRIPT_DIR_MOODLE_DOCKER/moodlehq-docker" || abort "moodlehq-docker is missing"
  check_is_running

  log "üîÑ Stopping containers..."
  bin/moodle-docker-compose stop
  log ""
  log "${GREEN}‚úÖ Moodle $ARG2_SELECTED_VERSION containers stopped.${RESET}"
  log "${CYAN}üí° Tip: Use './moodle-docker start $ARG2_SELECTED_VERSION' to restart${RESET}"
  log ""

# BEHAT COMMAND
# ----------------------------------------------------------------
elif [ "$ARG1_ACTION" == "behat" ]; then
  log ""
  log "========================================================================"
  log "${GREEN}üß™ Running Behat Tests - Moodle $ARG2_SELECTED_VERSION${RESET}"
  log "========================================================================"
  log ""
  log "üîß Command: php admin/tool/behat/cli/run.php $ALL_REMAINING_ARGS"
  log ""

  cd "$SCRIPT_DIR_MOODLE_DOCKER/moodlehq-docker" || abort "moodlehq-docker is missing"
  check_is_running

  bin/moodle-docker-compose exec -i -u www-data webserver bash -ic "php admin/tool/behat/cli/run.php $ALL_REMAINING_ARGS"

# PHPUNIT COMMAND
# ----------------------------------------------------------------
elif [ "$ARG1_ACTION" == "phpunit" ]; then
  log ""
  log "========================================================================"
  log "${GREEN}üß¨ Running PHPUnit Tests - Moodle $ARG2_SELECTED_VERSION${RESET}"
  log "========================================================================"
  log ""
  log "üîß Command: vendor/bin/phpunit $ALL_REMAINING_ARGS"
  log ""

  cd "$SCRIPT_DIR_MOODLE_DOCKER/moodlehq-docker" || abort "moodlehq-docker is missing"
  check_is_running

  bin/moodle-docker-compose exec webserver vendor/bin/phpunit "$ALL_REMAINING_ARGS"

# GRUNT COMMAND
# ----------------------------------------------------------------
elif [ "$ARG1_ACTION" == "grunt" ]; then
  log ""
  log "========================================================================"
  log "${GREEN}üî® Grunt Watch - Moodle $ARG2_SELECTED_VERSION${RESET}"
  log "========================================================================"
  log ""

  # Usage: moodle-docker grunt {version} [watch]
  cd "$SCRIPT_DIR_MOODLE_DOCKER/moodlehq-docker" || abort "moodlehq-docker is missing"
  check_is_running

  GRUNT_SUBCOMMAND="$3"
  if [ -z "$GRUNT_SUBCOMMAND" ]; then
    GRUNT_SUBCOMMAND="watch"
  fi

  if [ "$GRUNT_SUBCOMMAND" != "watch" ]; then
    abort "‚ùå Unknown grunt subcommand: $GRUNT_SUBCOMMAND (supported: watch)"
  fi

  log "üëÄ Starting grunt watch (will auto-rebuild JS/CSS on file changes)"
  log "${YELLOW}üí° Press Ctrl+C to stop watching${RESET}"
  log ""

  if [ "${MOODLE_DOCKER_GRUNT_METHOD:-dockerexec}" = "compose" ]; then
    # Run grunt watch with NVM bootstrap inside the container for www-data.
    bin/moodle-docker-compose exec -it -u www-data webserver bash -lc '
    set -uo pipefail
    export NVM_DIR="/var/www/html/.nvm"
    mkdir -p "$NVM_DIR"
    if [ ! -s "$NVM_DIR/nvm.sh" ]; then
      if command -v curl >/dev/null 2>&1; then
        curl -fsSL https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
      elif command -v wget >/dev/null 2>&1; then
        wget -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.3/install.sh | bash
      else
        echo "curl or wget required to install nvm" >&2
        exit 1
      fi
    fi
    # shellcheck disable=SC1090
    . "$NVM_DIR/nvm.sh"

    cd /var/www/html
    NODEVER="20"
    if [ -f package.json ]; then
      echo "Checking package.json for Node version requirements..."
      NODE_REQ=$(grep -oE "\"node\"[[:space:]]*:[[:space:]]*\"[^\"]*\"" package.json 2>/dev/null | head -1)
      echo "Found Node requirement: $NODE_REQ"

      if echo "$NODE_REQ" | grep -qE "22\.|>=22" 2>/dev/null; then
        NODEVER="22"
      elif echo "$NODE_REQ" | grep -qE "20\.|>=20" 2>/dev/null; then
        NODEVER="20"
      elif echo "$NODE_REQ" | grep -qE "18\.|>=18" 2>/dev/null; then
        NODEVER="18"
      elif echo "$NODE_REQ" | grep -qE "16\.|>=16" 2>/dev/null; then
        NODEVER="16"
      fi
    fi

    echo "Using Node $NODEVER"
    nvm install "$NODEVER"
    nvm use "$NODEVER"
    node -v
    npm -v

    # Ensure grunt-cli and dependencies
    npm install -g grunt-cli
    if [ -f package-lock.json ]; then
      npm ci
    else
      npm install
    fi

    echo "Starting grunt watch (Ctrl+C to stop)"
    echo "========================================="

    # Trap SIGINT (Ctrl+C) to ensure clean exit
    trap "echo Stopping grunt watch...; exit 0" INT TERM

    # Run grunt watch with unbuffered output
    grunt watch
  '
  else
    # Fallback/default: use docker exec directly for reliable streaming
    container_name="${COMPOSE_PROJECT_NAME}-webserver-1"
    log "Attaching to container: $container_name"
    log "${YELLOW}Installing dependencies if needed (this may take a moment on first run)..."

    # Ensure bash and curl/wget are present for nvm install (best-effort; ignore failures)
    docker exec -u root "$container_name" sh -c 'command -v bash >/dev/null 2>&1 || (apt-get update && apt-get install -y bash >/dev/null 2>&1 || apk add --no-cache bash >/dev/null 2>&1 || dnf -y install bash >/dev/null 2>&1 || yum -y install bash >/dev/null 2>&1 || true)' 2>/dev/null
    docker exec -u root "$container_name" sh -c 'command -v curl >/dev/null 2>&1 || command -v wget >/dev/null 2>&1 || (apt-get update && apt-get install -y curl >/dev/null 2>&1 || apk add --no-cache curl >/dev/null 2>&1 || dnf -y install curl >/dev/null 2>&1 || yum -y install curl >/dev/null 2>&1 || true)' 2>/dev/null

    # Copy the runner script into the container then execute with a TTY for live output
    docker cp "$SCRIPT_DIR_MOODLE_DOCKER/scripts/grunt_watch_inside_container.sh" "$container_name:/tmp/grunt_watch_inside_container.sh"

    # Make script executable
    docker exec "$container_name" chmod +x /tmp/grunt_watch_inside_container.sh

    # Run the script with proper TTY allocation
    docker exec -it -u www-data "$container_name" bash -lc '/tmp/grunt_watch_inside_container.sh'
  fi

# UPDATE COMMAND
# ----------------------------------------------------------------
elif [ "$ARG1_ACTION" == "update" ]; then

  log "${GREEN}Updating container behat + unit tests init again."
  cd "$SCRIPT_DIR_MOODLE_DOCKER/moodlehq-docker" || abort "moodlehq-docker is missing"
  check_is_running

  # Initialize behat environment.
  log "Installing Moodle behat"
  bin/moodle-docker-compose exec webserver php admin/tool/behat/cli/init.php

  # Initialize phpunit environment.
  log "Installing Moodle phpunit"
  bin/moodle-docker-compose exec webserver php admin/tool/phpunit/cli/init.php

else
  log "Unknown command $ARG1_ACTION"
fi
